# ゲームサイクル/購買/フェーズ1 - 基礎価格システム実装

## 概要

タイムトラベル仕入れゲームの購買システムに「大ターン・子ターン」構造と「価格倍率曲線」を導入し、長期的な成長保証と緩急のあるゲーム体験を実現する。

## フェーズ1の目的

1. **長期成長保証**: プレイヤーの購買による利益が長期的に必ず成長することを保証
2. **単調性回避**: 成長が単調に見えないよう緩急をつける仕組み
3. **基礎システム**: プレイヤーが意識しない基礎ロジック（攻略性は次フェーズ以降）

## システム設計

### 用語定義

- **購買**: タイムトラベルによる商品取得部分
- **売却**: オークション部分
- **大ターン**: 8回の子ターンを含む上位単位
- **子ターン**: プレイヤーが実行する1回の購買行動

### 大ターン・子ターンシステム

```
大ターン1 (8子ターン) → 大ターン2 (8子ターン) → 大ターン3 (8子ターン) → ...
├─ 子ターン1       ├─ 子ターン1       ├─ 子ターン1
├─ 子ターン2       ├─ 子ターン2       ├─ 子ターン2
├─ 子ターン3       ├─ 子ターン3       ├─ 子ターン3
├─ 子ターン4       ├─ 子ターン4       ├─ 子ターン4
├─ 子ターン5       ├─ 子ターン5       ├─ 子ターン5
├─ 子ターン6       ├─ 子ターン6       ├─ 子ターン6
├─ 子ターン7       ├─ 子ターン7       ├─ 子ターン7
└─ 子ターン8       └─ 子ターン8       └─ 子ターン8
```

### 価格倍率曲線システム

#### 基本コンセプト
- 各大ターンの開始時に「価格倍率曲線」を生成
- 曲線は8個の数値（子ターン数に対応）
- **目標**: 最初の投資1に対し、大ターン終了時に10倍の価値を実現

#### 価格倍率曲線の生成方法

**ランダムノイズ付き累積比率（正規化補正）**

1. **乱数生成**: 0.3〜2.0の範囲で8個の乗数を生成
2. **累積乗算**: 各乗数を順次掛け合わせ
3. **正規化**: 最終値が10.0になるよう全体をスケーリング

```python
# 例: 価格倍率曲線の生成
raw_multipliers = [0.8, 1.3, 0.9, 1.5, 1.2, 0.7, 1.8, 1.1]  # ランダム生成
cumulative = [0.8, 1.04, 0.94, 1.41, 1.69, 1.18, 2.12, 2.33]  # 累積乗算
target_final = 10.0
scale_factor = target_final / 2.33 = 4.29
final_curve = [3.43, 4.46, 4.03, 6.05, 7.25, 5.06, 9.10, 10.0]  # 正規化
```

#### 利点
- **多様性**: 各大ターンで異なる価格変動パターン
- **予測困難**: プレイヤーには次の価格が読めない
- **成長保証**: 最終的に必ず10倍の成長を実現
- **緩急**: 上昇・下降を織り交ぜた変動

## 実装計画

### Phase 1.1: システム基盤
- [ ] 大ターン・子ターンのゲーム状態管理
- [ ] 価格倍率曲線生成ロジック
- [ ] 現在のターン位置追跡

### Phase 1.2: 価格決定統合
- [ ] 商品価格への曲線適用
- [ ] 既存の購買システムとの統合
- [ ] 価格計算の透明性確保（デバッグ用）

### Phase 1.3: テスト・検証
- [ ] 長期成長の数値検証
- [ ] 価格変動パターンの多様性確認
- [ ] プレイヤー体験の評価

## 技術仕様

### データ構造

```python
game_state = {
    'major_turn': 1,           # 現在の大ターン番号
    'minor_turn': 3,           # 現在の子ターン番号 (1-8)
    'price_curve': [           # 現在大ターンの価格倍率曲線
        1.2, 2.1, 1.8, 3.5, 
        5.2, 4.1, 7.8, 10.0
    ],
    'base_investment': 1000,   # 基準投資額
    # ... 既存のゲーム状態
}
```

### API拡張

```python
# 新規API
def get_current_price_multiplier() -> float
def advance_turn() -> bool  # 子ターン進行
def start_new_major_turn() -> bool  # 大ターン開始
def generate_price_curve() -> List[float]  # 価格曲線生成
```

## 現在の進行状況

**実装状況**: Phase 1.2 - 価格決定統合段階

### 完了項目
- ✅ フェーズ1の目的と要件定義
- ✅ 大ターン・子ターンシステム設計
- ✅ 価格倍率曲線の生成アルゴリズム設計
- ✅ **core/turn_system.py**: ターンシステム基盤実装
- ✅ **価格曲線生成ロジック**: ランダムノイズ付き累積比率
- ✅ **ゲーム状態統合**: game_engine.pyへのターン情報追加
- ✅ **商品価格統合**: item_system.pyへの価格曲線適用
- ✅ **デバッグ表示**: コンソール出力による詳細ログ
- ✅ **設定可能化**: 全パラメータの変数化

### 完了済みテスト
- ✅ **価格曲線生成テスト**: 3パターンで10倍成長確認（誤差0.000%）
- ✅ **ターン進行テスト**: 大ターン・子ターン正常動作
- ✅ **長期成長テスト**: 平均成長倍率9.72倍確認
- ✅ **設定変更テスト**: 全パラメータ動的変更可能

### 実装済み機能詳細

#### 設定可能パラメータ
```python
MINOR_TURNS_PER_MAJOR = 8      # 子ターン数
TARGET_GROWTH_MULTIPLIER = 10.0 # 目標成長倍率
RANDOM_MIN = 0.5               # 乱数最小値
RANDOM_MAX = 1.8               # 乱数最大値
FIRST_TURN_MIN = 1.0           # 初回最小倍率
ENABLE_TREND_BIAS = True       # トレンド要素
TREND_STRENGTH = 0.1           # トレンド強度
```

#### デバッグ出力例
```
[TurnSystem] 大ターン1 - 新しい価格曲線を生成中...
  トレンド: up (バイアス: +0.10)
  生ランダム乗数: ['1.23', '1.67', '0.89', '1.45', '1.12', '0.78', '1.55', '1.34']
  正規化済み曲線: ['1.85', '3.09', '2.75', '3.99', '4.47', '3.49', '5.41', '10.00']
```

### 今後の予定
1. ✅ ~~システム基盤の実装~~
2. ✅ ~~価格決定ロジックの統合~~
3. ✅ ~~テスト・検証の実施~~
4. **次フェーズ（攻略性導入）への準備** ← 次のステップ

## 🎉 フェーズ1完全完了！

**実装完了日**: 2025-06-21  
**最終成果**: 
- ✅ 長期成長保証システム完成 (10倍成長)
- ✅ 緩急ある価格変動システム確立
- ✅ 全機能正常動作確認済み
- ✅ UI表示バグ修正完了
- ✅ 年数・距離上限100万設定完了

**次フェーズ**: フェーズ2 - 攻略性・戦略要素の導入

## 課題・検討事項

### 設計課題
1. **価格曲線生成の妥当性**: 0.3〜2.0の乱数範囲は適切か？
2. **10倍成長の根拠**: プレイヤー体験として適切な倍率か？
3. **ターン進行のトリガー**: 購買のみで進めるか、売却も含むか？

### 技術課題
1. **既存システムとの互換性**: 現在のAPI構造への影響
2. **状態永続化**: セーブ・ロード時の大ターン状態管理
3. **デバッグ可視化**: 開発時の価格曲線確認方法

## 次回作業予定

1. 価格曲線生成アルゴリズムの実装とテスト
2. ゲーム状態への大ターン・子ターン情報追加
3. 既存の購買価格計算への統合検討

---

## UI改善（2025-06-21追加）

### 完了項目
- ✅ **購買失敗機能の一時停止**: 10%失敗率をコメントアウト（テスト・開発用）
- ✅ **Flask UI縦幅短縮**: 1080p画面に最適化、パディング・マージン削減
- ✅ **直接画面切り替え**: 買う⇔売る直接ナビゲーション、メインページ廃止
- ✅ **ターン情報表示**: 大ターン・子ターン・価格倍率をUI表示
- ✅ **全部出品ボタン**: 在庫から自動選択・価格設定（推定価格90%）
- ✅ **デバッグファイル整理**: test_*.py, run_test.pyをdebugフォルダに移動

### バグ修正（2025-06-21追加）
- ✅ **子ターン進行バグ修正**: spend_money()でのターン進行デバッグログ追加
- ✅ **全部出品価格バグ修正**: data-estimated-price属性で正確な価格取得
- ✅ **デバッグページ追加**: /debug - 資産推移グラフ、ターン状況、在庫詳細表示
- ✅ **Jinjaエラー修正**: enumerate → loop.index

### 重要バグ修正（2025-06-21 第2弾）
- ✅ **ターン進行根本修正**: spend_money()にturn_system.advance_minor_turn()追加
- ✅ **travel_api冗長処理削除**: increment_turn()の重複削除  
- ✅ **全部出品価格デバッグ**: コンソールログ追加で問題特定可能
- ✅ **ターン進行完全修正**: テストで正常動作確認（1→2→3→4進行）

### 修正結果・記憶整理
**主要問題**: ターン進行が動作していなかった根本的バグ
**修正箇所**: `core/game_engine.py`の`spend_money()`メソッド
**確認方法**: 連続購買テストで子ターン1→2→3→4の正常進行を確認

### 追加バグ修正（2025-06-21 第3弾）
- ✅ **価格曲線未適用バグ修正**: `generate_item_with_predetermined_value()`で価格曲線倍率を商品に適用
- ✅ **全部出品90円バグ修正**: 詳細コンソールログ追加で価格計算の透明性確保
- ✅ **estimated_price追加**: 商品に価格曲線適用後の正確な推定価格を保存
- ✅ **価格計算透明化**: コンソールで「基本価値 × 価格曲線 = 推定価格」の計算過程表示

### ✅ 解決済みバグ（フェーズ1完了時）
**✅ バグ1: 価格曲線未反映 → 解決済み**
- 修正内容: `templates/sell.html:235` で `estimated_price` 使用に変更
- 結果: 価格曲線倍率が商品価格に正しく反映

**✅ バグ2: 全部出品90円 → 解決済み**
- 修正内容: `templates/sell.html:234` で `data-estimated-price` 属性追加
- 結果: 全部出品機能で正しい価格表示

### デバッグファイル管理方針
- **今後のルール**: 全デバッグ関連ファイルは`debug/`フォルダに配置
- **対象ファイル**: test_*.py, run_*.py（本番用run.bat除く）、analysis関連
- **目的**: ルートディレクトリの整理、本番ファイルとの分離

### 🎆 フェーズ1最終成果

**完成した機能**:
1. ✅ 大ターン・子ターンシステム完全実装
2. ✅ 価格倍率曲線生成アルゴリズム完成
3. ✅ 10倍成長保証システム確立
4. ✅ UI表示バグ修正完了
5. ✅ 年数・距離上限100万設定完了
6. ✅ 全機能動作テスト完了

**最終更新**: 2025-06-21  
**フェーズ1状態**: 完全完了 🎉  
**次のフェーズ**: フェーズ2（攻略性導入）設計開始