# ゲームサイクル/購買/フェーズ2 - 戦略性・攻略性の導入

## 概要

フェーズ1で確立した長期成長保証システムに戦略性を導入し、プレイヤーの選択が結果に影響するゲーム性を実現する。

## フェーズ2の目的

1. **戦略的選択**: プレイヤーの投資判断が利益に直結
2. **攻略性導入**: 市場情報を読み取る楽しさの提供
3. **リスク管理**: 固定費によるプレッシャーと資産管理

## 主要変更点

### 1. 価格倍率曲線の可変化

#### 現行仕様（フェーズ1）
- 固定10倍成長保証
- ランダムな緩急はあるが最終的に必ず10倍

#### 新仕様（フェーズ2）
```
目標倍率 = 1.0倍 ～ 10.0倍 のランダム決定
- 1.0倍 = 投資額と同等の価値（損益なし）
- 10.0倍 = 投資額の10倍の価値（900%利益）
```

#### 決定タイミング
- **大ターン開始時**: 新しい目標倍率をランダム決定
- **子ターン中**: 決定された目標倍率に向けて価格曲線生成
- **大ターン更新**: 再度ランダムで新しい目標倍率決定

### 2. 目標倍率の表示とゲーム性

#### UI表示
- **場所**: 購買ページにデバッグ情報として表示
- **内容**: 現在の大ターンの目標倍率（例：「目標倍率: 7.2倍」）
- **将来拡張**: フレーバーテキストで「市場の雰囲気」として表現予定

#### ゲーム性
```
高倍率時（7倍以上）→ 積極投資で大きな利益狙い
中倍率時（3-6倍）→ 適度な投資でバランス良く成長
低倍率時（1-2倍）→ 投資控えめ、固定費対策を優先
```

### 3. UFOシステムの大幅変更

#### 廃止要素
- ✅ UFOサイズパラメータ（1.0～10.0倍）
- ✅ サイズによる商品個数変動
- ✅ サイズ倍率によるコスト計算

#### 新システム: UFO固定費
```
UFO代金 = 資産 × 0.05（5%）
```

#### 支払いタイミング
- **タイミング**: 購買操作実行のたび
- **計算**: 購買操作直前の資産額から算出
- **強制徴収**: 投資額とは別に必ず徴収

### 4. 資産システムの導入

#### 資産の定義
```
資産 = 現金 + 在庫価値合計
在庫価値 = Σ(各商品のbase_value)
```

#### 資産の役割
1. **UFO代金計算**: 固定費の基準
2. **ゲームオーバー判定**: 生存可能性の指標
3. **投資判断材料**: プレイヤーの戦略立案

### 5. ゲームオーバーシステム

#### 条件
```
資産 < UFO代金 = ゲームオーバー
```

#### 判定タイミング
- **購買前**: UFO代金支払い可能性チェック
- **支払い後**: 残資産でのゲーム継続可能性判定

#### ゲームオーバー時の処理
1. **メッセージ表示**: 「資産不足でゲーム継続不可能」
2. **リセットUI表示**: ゲーム初期化ボタン
3. **操作制限**: 購買・売却ボタン無効化

## 技術仕様

### データ構造拡張

```python
game_state = {
    # フェーズ1から継続
    'major_turn': 1,
    'minor_turn': 3,
    'price_curve': [...],
    'money': 1000,
    'inventory': [...],
    
    # フェーズ2で追加
    'target_multiplier': 7.2,    # 目標倍率
    'assets': 15000,             # 資産
    'fixed_cost': 750,           # UFO代金
    'game_over': False           # ゲームオーバー状態
}
```

### API拡張

```python
# 新規API
def calculate_assets() -> float           # 資産計算
def calculate_fixed_cost() -> float      # UFO代金計算
def check_game_over() -> bool           # ゲームオーバー判定
def generate_target_multiplier() -> float # 目標倍率生成
def reset_game() -> None                # ゲームリセット
```

### 設定パラメータ

```python
# core/phase2_config.py
TARGET_MULTIPLIER_MIN = 1.0    # 最小目標倍率（100%）
TARGET_MULTIPLIER_MAX = 10.0   # 最大目標倍率（1000%）
FIXED_COST_RATE = 0.05         # 固定費率（5%）
INVENTORY_SELL_RATE = 1.0      # 在庫売却率（100%）
```

## 実装計画

### Phase 2.1: コアロジック実装 ✅
- ✅ 目標倍率生成システム
- ✅ 資産計算システム
- ✅ 固定費計算システム
- ✅ ゲームオーバー判定

### Phase 2.2: 価格曲線システム改修 ✅
- ✅ 可変目標倍率対応
- ✅ 価格曲線生成アルゴリズム更新
- ✅ ターンシステム連携

### Phase 2.3: 購買システム統合 ✅
- ✅ UFOサイズパラメータ廃止
- ✅ 購買時固定費徴収システム実装
- ✅ ゲームエンジンにAssetManager統合
- ✅ 購買前バリデーション実装
- ✅ 目標倍率表示
- ✅ 資産・固定費表示
- ✅ UFOサイズ関連UI削除

### Phase 2.4: テスト・バランス調整
- [ ] 各種パラメータの動作検証
- [ ] ゲーム性のバランステスト
- [ ] エッジケース対応

## 期待される効果

### ゲーム性の向上
1. **戦略的思考**: 目標倍率を見て投資額を調整
2. **リスク管理**: 固定費を考慮した資産管理
3. **タイミング**: いつ投資し、いつ控えるかの判断

### プレイヤー体験
1. **能動的参加**: 受動的→能動的なゲーム体験
2. **学習要素**: 市場の読み方を覚える楽しさ
3. **緊張感**: 固定費によるプレッシャー

## 懸念事項と対策

### 1. バランスの難しさ
- **懸念**: 固定費が高すぎるとゲームオーバー頻発
- **対策**: 段階的なパラメータ調整とテストプレイ

### 2. 戦略の単純化
- **懸念**: 高倍率=投資、低倍率=控える の単純な判断
- **対策**: 将来フェーズで複雑な要素を段階的追加

### 3. 初心者の理解困難
- **懸念**: システムが複雑になりすぎる
- **対策**: UI説明とチュートリアル機能の検討

## 実装状況

### ✅ 完了済み（Phase 2.1 & 2.2）
- **設定システム**: `core/phase2_config.py`
- **資産管理**: `core/asset_manager.py`
- **ターンシステム改修**: `core/turn_system.py`
- **可変目標倍率**: 0.1倍～10.0倍のランダム生成
- **価格曲線**: 目標倍率に合わせた動的生成

### 📋 次のステップ（Phase 2.4）
- ゲームオーバーUI実装
- リセット機能実装
- システム統合テスト

---

**フェーズ2目標**: プレイヤーの選択が結果に影響する戦略的ゲーム性の確立  
**成功指標**: 能動的な投資判断による利益最大化の実現  
**進捗**: Phase 2.1 & 2.2 & 2.3 完了（Phase 2.4 開始準備完了）